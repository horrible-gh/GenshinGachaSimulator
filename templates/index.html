<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gacha Simulation</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f8ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .form-control, .btn {
            margin-top: 10px;
        }
        #result, #stats, #result_per_simulation, #result_gacha, #warnings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Gacha Simulation</h1>
        <!-- 탭 네비게이션 -->
        <ul class="nav nav-tabs" id="simulationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="gacha-tab" data-bs-toggle="tab" data-bs-target="#gacha" type="button" role="tab" aria-controls="gacha" aria-selected="true">Gacha Simulation</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="per_simulation-tab" data-bs-toggle="tab" data-bs-target="#per_simulation" type="button" role="tab" aria-controls="per_simulation" aria-selected="false">Per Simulation</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="warnings-tab" data-bs-toggle="tab" data-bs-target="#warnings" type="button" role="tab" aria-controls="warnings" aria-selected="false">경고문</button>
            </li>
        </ul>
        <div class="tab-content" id="simulationTabsContent">
            <!-- Gacha Simulation 탭 -->
            <div class="tab-pane fade show active" id="gacha" role="tabpanel" aria-labelledby="gacha-tab">
                <div class="card p-4 mt-3">
                    <form id="gacha-form">
                        <div class="mb-3">
                            <label for="gacha_type" class="form-label">가챠 유형 선택</label>
                            <select id="gacha_type" name="gacha_type" class="form-control" required>
                                <option value="1">캐릭터</option>
                                <option value="2">무기</option>
                            </select>
                        </div>
                        <!-- 입력 방식 선택 -->
                        <div class="mb-3">
                            <label class="form-label">입력 방식 선택</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method_gacha" id="input_pulls_gacha" value="pulls" checked>
                                    <label class="form-check-label" for="input_pulls_gacha">가챠 횟수</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method_gacha" id="input_gemstones_gacha" value="gemstones">
                                    <label class="form-check-label" for="input_gemstones_gacha">원석</label>
                                </div>
                            </div>
                        </div>
                        <!-- 가챠 횟수 입력 필드 -->
                        <div class="mb-3" id="pulls_input_field_gacha">
                            <label for="pulls_gacha" class="form-label">가챠 횟수 입력</label>
                            <input type="number" id="pulls_gacha" name="pulls" class="form-control" min="1" required>
                        </div>
                        <!-- 원석 입력 필드 -->
                        <div class="mb-3" id="gemstones_input_field_gacha" style="display: none;">
                            <label for="gemstones_gacha" class="form-label">원석 입력</label>
                            <input type="number" id="gemstones_gacha" name="gemstones" class="form-control" min="160" required>
                            <small class="form-text text-muted">1 가챠는 160 원석입니다.</small>
                        </div>
                        <button type="button" id="start-gacha" class="btn btn-primary w-100">시뮬레이션 시작</button>
                    </form>
                </div>
                <h2>시뮬레이션 통계</h2>
                <pre id="stats_gacha" class="border"></pre>
                <h2>상세 내역</h2>
                <pre id="result_gacha" class="border"></pre>
            </div>
            <!-- Per Simulation 탭 -->
            <div class="tab-pane fade" id="per_simulation" role="tabpanel" aria-labelledby="per_simulation-tab">
                <div class="card p-4 mt-3">
                    <form id="per_simulation-form">
                        <!-- 가챠수 또는 원석 선택 -->
                        <div class="mb-3">
                            <label class="form-label">입력 방식 선택</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_pulls" value="pulls" checked>
                                    <label class="form-check-label" for="input_pulls">가챠 횟수</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="input_method" id="input_gemstones" value="gemstones">
                                    <label class="form-check-label" for="input_gemstones">원석</label>
                                </div>
                            </div>
                        </div>
                        <!-- 가챠 횟수 입력 필드 -->
                        <div class="mb-3" id="pulls_input_field">
                            <label for="pulls_per_simulation" class="form-label">가챠 횟수 입력</label>
                            <input type="number" id="pulls_per_simulation" name="pulls" class="form-control" min="1" required>
                        </div>
                        <!-- 원석 입력 필드 -->
                        <div class="mb-3" id="gemstones_input_field" style="display: none;">
                            <label for="gemstones_per_simulation" class="form-label">원석 입력</label>
                            <input type="number" id="gemstones_per_simulation" name="gemstones" class="form-control" min="160" required>
                            <small class="form-text text-muted">1 가챠는 160 원석입니다.</small>
                        </div>
                        <!-- 목표 캐릭터 수 -->
                        <div class="mb-3">
                            <label for="target_character" class="form-label">목표 캐릭터 수</label>
                            <input type="number" id="target_character" name="target_character" class="form-control" min="0" value="0" required>
                        </div>
                        <!-- 목표 무기 수 -->
                        <div class="mb-3">
                            <label for="target_weapon" class="form-label">목표 무기 수</label>
                            <input type="number" id="target_weapon" name="target_weapon" class="form-control" min="0" value="0" required>
                        </div>
                        <button type="button" id="start-per_simulation" class="btn btn-primary w-100">시뮬레이션 시작</button>
                    </form>
                </div>
                <h2>시뮬레이션 결과</h2>
                <pre id="result_per_simulation" class="border"></pre>
            </div>
            <!-- Warnings 탭 -->
            <div class="tab-pane fade" id="warnings" role="tabpanel" aria-labelledby="warnings-tab">
                <div class="card p-4 mt-3">
                    <h2>주의사항 및 이용 약관</h2>
                    <pre id="warnings_content" class="border">
본 프로그램을 이용함으로써, 사용자는 아래의 경고사항에 동의한 것으로 간주됩니다.

1. 본 사이트는 공식 원신(Genshin Impact) 사이트와 어떠한 관련도 없습니다.
2. 본 사이트는 어떠한 개인정보도 저장하지 않습니다.
3. 본 프로그램의 사용으로 인해 발생하는 모든 문제에 대하여 책임을 지지 않습니다.
4. 본 프로그램의 로직은 사전 예고 없이 변경될 수 있습니다.
5. 본 프로그램은 제공되는 정보의 정확성을 보장하지 않으며, 사용자는 이를 참고용으로만 활용해야 합니다.
6. 본 사이트에 사용된 모든 콘텐츠는 저작권 및 지적 재산권의 보호를 받습니다.
7. 본 사이트는 사전 통보 없이 서비스를 변경하거나 중단할 권리를 보유합니다.
8. 본 프로그램의 사용은 전적으로 사용자의 책임 하에 이루어집니다.
9. 본 사이트는 사용자의 행위로 인해 발생하는 모든 손해에 대하여 법적 책임을 지지 않습니다.
                    </pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS (탭 기능을 위해 필요) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        var context = "/genshin_gacha_simulator"
        $(document).ready(function(){
            // 입력 방식 변경 시 필드 토글 - Per Simulation
            $("input[name='input_method']").change(function(){
                if($(this).val() === 'pulls'){
                    $("#pulls_input_field").show();
                    $("#gemstones_input_field").hide();
                    $("#gemstones_per_simulation").val('0'); // 변경: 빈 문자열에서 '0'으로 수정
                    $("#gemstones_per_simulation").removeAttr('required');
                    $("#pulls_per_simulation").attr('required', 'required');
                } else {
                    $("#pulls_input_field").hide();
                    $("#gemstones_input_field").show();
                    $("#pulls_per_simulation").val('0'); // 변경: 빈 문자열에서 '0'으로 수정
                    $("#pulls_per_simulation").removeAttr('required');
                    $("#gemstones_per_simulation").attr('required', 'required');
                }
            });

            // 입력 방식 변경 시 필드 토글 - Gacha Simulation
            $("input[name='input_method_gacha']").change(function(){
                if($(this).val() === 'pulls'){
                    $("#pulls_input_field_gacha").show();
                    $("#gemstones_input_field_gacha").hide();
                    $("#gemstones_gacha").val('0'); // 변경: 빈 문자열에서 '0'으로 수정
                    $("#gemstones_gacha").removeAttr('required');
                    $("#pulls_gacha").attr('required', 'required');
                } else {
                    $("#pulls_input_field_gacha").hide();
                    $("#gemstones_input_field_gacha").show();
                    $("#pulls_gacha").val('0'); // 변경: 빈 문자열에서 '0'으로 수정
                    $("#pulls_gacha").removeAttr('required');
                    $("#gemstones_gacha").attr('required', 'required');
                }
            });

            // Gacha Simulation AJAX
            $("#start-gacha").click(function(){
                var gacha_type = $("#gacha_type").val();
                var pulls;

                var input_method_gacha = $("input[name='input_method_gacha']:checked").val();

                if(input_method_gacha === 'pulls'){
                    pulls = $("#pulls_gacha").val();
                } else {
                    var gemstones = $("#gemstones_gacha").val();
                    pulls = Math.floor(gemstones / 160);
                }

                if(pulls < 1){
                    alert("원석이 부족하여 최소 1 가챠를 할 수 없습니다.");
                    return;
                }

                var pulls_int = parseInt(pulls);
                var target_character = parseInt($("#target_character").val());
                var target_weapon = parseInt($("#target_weapon").val());

                // 입력 값 유효성 검사
                if(isNaN(pulls_int) || pulls_int <= 0){
                    alert("가챠 횟수는 1 이상이어야 합니다.");
                    return;
                }

                // 버튼 클릭 시 스타일링 효과 추가
                $("#start-gacha").prop("disabled", true).removeClass("btn-primary").addClass("btn-success").text("진행 중...");

                $.ajax({
                    url: context + "/gacha/simulate",
                    type: "POST",
                    data: {gacha_type: gacha_type, pulls: pulls_int},
                    success: function(response){
                        if(response.error){
                            $("#stats_gacha").text(response.error);
                            $("#result_gacha").text("");
                        } else {
                            $("#stats_gacha").hide().html(response.stats).fadeIn(800);
                            $("#result_gacha").hide().html(response.details).fadeIn(800);
                        }
                        $("#start-gacha").prop("disabled", false).removeClass("btn-success").addClass("btn-primary").text("시뮬레이션 시작");
                    },
                    error: function(xhr){
                        if(xhr.responseJSON && xhr.responseJSON.error){
                            $("#stats_gacha").text(xhr.responseJSON.error);
                        } else {
                            $("#stats_gacha").text("오류가 발생했습니다. 입력 값을 확인하세요.");
                        }
                        $("#result_gacha").text("");
                        $("#start-gacha").prop("disabled", false).removeClass("btn-success").addClass("btn-primary").text("시뮬레이션 시작");
                    }
                });
            });

            // Per Simulation AJAX
            $("#start-per_simulation").click(function(){
                var pulls;
                var input_method = $("input[name='input_method']:checked").val();

                if(input_method === 'pulls'){
                    pulls = $("#pulls_per_simulation").val();
                } else {
                    var gemstones = $("#gemstones_per_simulation").val();
                    // 원석을 가챠 수로 변환 (160 원석 = 1 가챠, 소수점 버림)
                    pulls = Math.floor(gemstones / 160);
                }
                if(pulls < 1){
                    alert("원석이 부족하여 최소 1 가챠를 할 수 없습니다.");
                    return;
                }

                var pulls_int = parseInt(pulls);
                var target_character = parseInt($("#target_character").val());
                var target_weapon = parseInt($("#target_weapon").val());

                // 입력 값 유효성 검사
                if(isNaN(pulls_int) || pulls_int <= 0){
                    alert("가챠 횟수는 1 이상이어야 합니다.");
                    return;
                }
                if(isNaN(target_character) || isNaN(target_weapon)){
                    alert("목표 캐릭터 수와 목표 무기 수는 숫자여야 합니다.");
                    return;
                }
                if(target_character < 0){
                    alert("목표 캐릭터 수는 0 이상이어야 합니다.");
                    return;
                }
                if(target_weapon < 0){
                    alert("목표 무기 수는 0 이상이어야 합니다.");
                    return;
                }
                if(target_character === 0 && target_weapon === 0){
                    alert("목표 캐릭터 수와 목표 무기 수 중 최소 하나는 1 이상이어야 합니다.");
                    return;
                }

                // 버튼 클릭 시 스타일링 효과 추가
                $("#start-per_simulation").prop("disabled", true).removeClass("btn-primary").addClass("btn-success").text("진행 중...");

                $.ajax({
                    url: context + "/per_simulation/simulate",
                    type: "POST",
                    data: {pulls: pulls_int, target_character: target_character, target_weapon: target_weapon},
                    success: function(response){
                        if(response.error){
                            $("#result_per_simulation").text(response.error);
                        } else {
                            $("#result_per_simulation").hide().html(`목표 ${target_character} 캐릭터와 ${target_weapon} 무기를 획득할 확률: ${(response.probability * 100).toFixed(2)}%`).fadeIn(800);
                        }
                        $("#start-per_simulation").prop("disabled", false).removeClass("btn-success").addClass("btn-primary").text("시뮬레이션 시작");
                    },
                    error: function(xhr){
                        if(xhr.responseJSON && xhr.responseJSON.error){
                            $("#result_per_simulation").text(xhr.responseJSON.error);
                        } else {
                            $("#result_per_simulation").text("오류가 발생했습니다. 입력 값을 확인하세요.");
                        }
                        $("#start-per_simulation").prop("disabled", false).removeClass("btn-success").addClass("btn-primary").text("시뮬레이션 시작");
                    }
                });
            });
        });
    </script>
</body>
</html>
